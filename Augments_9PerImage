import os
import cv2
import albumentations as A
from pathlib import Path
import shutil
import random

TARGET_FOLDER = "" #input target folder here 
IMAGES_SUBFOLDER = "images" #exporting from label studio as YOLO with images will generate a folder with subfolders images and labels 
LABELS_SUBFOLDER = "labels"
workspace_root = Path.cwd()

# double check multiple possible locations for the target folder
possible_locations = [
    workspace_root / TARGET_FOLDER,
    workspace_root.parent / TARGET_FOLDER,
    Path.home() / "Downloads" / TARGET_FOLDER,
    Path.home() / "Documents" / TARGET_FOLDER,
]

base_dir = None
for location in possible_locations:
    if location.exists() and (location / IMAGES_SUBFOLDER).exists() and (location / LABELS_SUBFOLDER).exists():
        base_dir = location
        print(f"Found images and labels in: {base_dir.absolute()}")
        break

if base_dir is None:
    print(f"Could not find '{TARGET_FOLDER}' with {IMAGES_SUBFOLDER} and {LABELS_SUBFOLDER} directories!")
    exit(1)

images_dir = base_dir / IMAGES_SUBFOLDER
labels_dir = base_dir / LABELS_SUBFOLDER

# output directories, created in the same folder 
output_images_dir = base_dir / "augmented_images"
output_labels_dir = base_dir / "augmented_labels"
check_dir = base_dir / "double_checking" #displays examples of augmented images with bounding bxoes

for d in [output_images_dir, output_labels_dir, check_dir]:
    d.mkdir(parents=True, exist_ok=True)

# Augmenttion pipeline
transform_aggressive = A.Compose([
    # Geometric
    A.Affine(shift_limit=0.15, scale_limit=0.2, rotate_limit=30, shear=(-7.5, 7.5), p=0.7), #p value is the probability an augment is carried out. These values can be updated to make augmentation more or less agressive
    A.Perspective(scale=(0.1, 0.2), p=0.5),
    
    # Color & lighting
    A.RandomBrightnessContrast(brightness_limit=0.2, contrast_limit=0.2, p=0.8),
    A.HueSaturationValue(hue_shift_limit=25, sat_shift_limit=25, val_shift_limit=20, p=0.6),
    A.RGBShift(r_shift_limit=25, g_shift_limit=25, b_shift_limit=25, p=0.5),

    # Noise & blur - Fixed parameter names here
    A.GaussNoise(std_dev=(5, 25), p=0.5), 
    A.ISONoise(color_shift=(0.01, 0.05), intensity=(0.1, 0.2), p=0.4),
    A.MotionBlur(blur_limit=5, p=0.4),
    A.GaussianBlur(blur_limit=(2, 5), p=0.3),
    A.ImageCompression(quality_range=(75, 90), p=0.4), # Updated parameter name

    # Random occlusion - Fixed parameter names here
    A.CoarseDropout(
        num_holes_range=(1, 3), 
        hole_height_range=(5, 10), 
        hole_width_range=(5, 10), 
        p=0.4
    ),

    # Flip
    A.HorizontalFlip(p=0.5),
], bbox_params=A.BboxParams(format='yolo', label_fields=['class_labels'], min_visibility=0.1, clip = True))
# ------------------- LABEL FUNCTIONS -------------------
def read_yolo_labels(label_path):
    bboxes, class_labels = [], []
    if not label_path.exists():
        return bboxes, class_labels
    
    with open(label_path, 'r') as f:
        for line in f:
            parts = line.strip().split()
            if len(parts) < 5: continue
            class_id = int(parts[0])
            coords = [max(0.0, min(1.0, float(x))) for x in parts[1:5]]
            bboxes.append(coords)
            class_labels.append(class_id)
    return bboxes, class_labels

def write_yolo_labels(label_path, bboxes, class_labels):
    with open(label_path, 'w') as f:
        for class_id, bbox in zip(class_labels, bboxes):
            f.write(f"{class_id} {' '.join([f'{x:.6f}' for x in bbox])}\n")

# ------------------- VISUALIZATION FUNCTION -------------------
def create_verification_samples(num_samples=10):
    aug_images = list(output_images_dir.glob("*.[jpJP]*[npNP]*"))
    if not aug_images: return

    samples = random.sample(aug_images, min(num_samples, len(aug_images)))
    print(f"Drawing boxes on {len(samples)} samples in 'double_checking' folder...")

    for img_path in samples:
        img = cv2.imread(str(img_path))
        h, w, _ = img.shape
        label_path = output_labels_dir / f"{img_path.stem}.txt"
        
        if label_path.exists():
            with open(label_path, 'r') as f:
                for line in f:
                    parts = line.strip().split()
                    cls_id, cx, cy, bw, bh = parts[0], *map(float, parts[1:])
                    x1 = int((cx - bw/2) * w)
                    y1 = int((cy - bh/2) * h)
                    x2 = int((cx + bw/2) * w)
                    y2 = int((cy + bh/2) * h)
                    cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)
                    cv2.putText(img, f"ID:{cls_id}", (x1, max(y1-5, 15)), 
                                cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)
        
        cv2.imwrite(str(check_dir / f"verify_{img_path.name}"), img)

# ------------------- MAIN LOOP -------------------
def augment_dataset(num_augmentations=9):
    image_files = list(images_dir.glob("*.[jpJP]*[npNP]*"))
    total_images = len(image_files) # Get the count
    print(f"Starting: {total_images} source images found.")
    image_files = list(images_dir.glob("*.[jpJP]*[npNP]*"))
    print(f"Found {len(image_files)} images. Starting augmentation...")

    successful_augs = 0
    for idx, img_path in enumerate(image_files):
        image = cv2.imread(str(img_path))
        if image is None: continue
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

        label_path = labels_dir / f"{img_path.stem}.txt"
        bboxes, class_labels = read_yolo_labels(label_path)

        # Save original copy
        shutil.copy(img_path, output_images_dir / img_path.name)
        if label_path.exists():
            shutil.copy(label_path, output_labels_dir / label_path.name)

        for i in range(num_augmentations):
            try:
                augmented = transform_aggressive(image=image, bboxes=bboxes, class_labels=class_labels)
                aug_img_name = f"{img_path.stem}_aug_{i}{img_path.suffix}"
                
                cv2.imwrite(str(output_images_dir / aug_img_name), cv2.cvtColor(augmented['image'], cv2.COLOR_RGB2BGR))
                write_yolo_labels(output_labels_dir / f"{img_path.stem}_aug_{i}.txt", 
                                  augmented['bboxes'], augmented['class_labels'])
                successful_augs += 1
            except Exception as e:
                print(f"Error on {img_path.name}: {e}")
        # This goes at the end of the main image loop
        print(f"Progress: {idx+1}/{total_images} | Processed: {img_path.name}", end='\r')



    print(f"\nDone! Saved {successful_augs} augmented images.")
    create_verification_samples(10)

if __name__ == "__main__":
    augment_dataset()
